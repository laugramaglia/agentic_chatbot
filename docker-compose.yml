version: '3.8'

# =============================================================================
# YAML Anchors - Reusable Configuration Blocks
# =============================================================================

x-common-service: &common-service
  restart: unless-stopped
  networks:
    - chatbot-network
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"

x-common-healthcheck: &common-healthcheck
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 40s

x-surrealdb-env: &surrealdb-env
  SURREALDB_URL: ${SURREALDB_URL}
  SURREALDB_NAMESPACE: ${SURREALDB_NAMESPACE:-production}
  SURREALDB_DATABASE: ${SURREALDB_DATABASE:-chatbot}

x-service-discovery-env: &service-discovery-env
  CHAT_SERVICE_URL: http://chat-service:8081
  CART_SERVICE_URL: http://cart-service:8082
  PRODUCT_SERVICE_URL: http://product-service:8083
  SESSION_SERVICE_URL: http://session-service:8084
  RECOMMEND_SERVICE_URL: http://recommendation-service:8085

x-golang-build-args: &golang-build-args
  GO_VERSION: ${GO_VERSION:-1.21}
  BUILD_ENV: ${BUILD_ENV:-production}

# =============================================================================
# Services
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # API Gateway
  # ---------------------------------------------------------------------------
  api-gateway:
    <<: *common-service
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
      args:
        <<: *golang-build-args
    container_name: chatbot-api-gateway
    ports:
      - "${API_GATEWAY_PORT:-8080}:8080"
    environment:
      <<: *service-discovery-env
      SERVICE_NAME: api-gateway
      PORT: 8080
      LOG_LEVEL: ${LOG_LEVEL:-info}

      # Authentication
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRY: ${JWT_EXPIRY:-24h}

      # Rate Limiting
      RATE_LIMIT_DEFAULT: ${RATE_LIMIT_DEFAULT:-100}
      RATE_LIMIT_CHAT: ${RATE_LIMIT_CHAT:-30}

      # Timeouts
      CHAT_SERVICE_TIMEOUT: ${CHAT_SERVICE_TIMEOUT:-30s}
      CART_SERVICE_TIMEOUT: ${CART_SERVICE_TIMEOUT:-10s}
      PRODUCT_SERVICE_TIMEOUT: ${PRODUCT_SERVICE_TIMEOUT:-15s}
      SESSION_SERVICE_TIMEOUT: ${SESSION_SERVICE_TIMEOUT:-10s}
      RECOMMEND_SERVICE_TIMEOUT: ${RECOMMEND_SERVICE_TIMEOUT:-20s}

      # CORS
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-*}
      CORS_ALLOWED_METHODS: ${CORS_ALLOWED_METHODS:-GET,POST,PUT,DELETE,OPTIONS}

    healthcheck:
      <<: *common-healthcheck
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
    depends_on:
      chat-service:
        condition: service_healthy
      cart-service:
        condition: service_healthy
      product-service:
        condition: service_healthy
      session-service:
        condition: service_healthy
      recommendation-service:
        condition: service_healthy

  # ---------------------------------------------------------------------------
  # Chat Service
  # ---------------------------------------------------------------------------
  chat-service:
    <<: *common-service
    build:
      context: ./chat-service
      dockerfile: Dockerfile
      args:
        <<: *golang-build-args
    container_name: chatbot-chat-service
    ports:
      - "${CHAT_SERVICE_PORT:-8081}:8081"
    environment:
      <<: *surrealdb-env
      SERVICE_NAME: chat-service
      PORT: 8081
      LOG_LEVEL: ${LOG_LEVEL:-info}

      # SurrealDB Auth
      SURREALDB_USER: chat_service
      SURREALDB_PASSWORD: ${CHAT_SERVICE_DB_PASSWORD}

      # Groq API
      GROQ_API_KEY: ${GROQ_API_KEY}
      GROQ_MODEL: ${GROQ_MODEL:-llama3-70b-8192}
      GROQ_TEMPERATURE: ${GROQ_TEMPERATURE:-0.7}
      GROQ_MAX_TOKENS: ${GROQ_MAX_TOKENS:-512}

      # Embedding Service
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-sentence-transformers/all-MiniLM-L6-v2}
      EMBEDDING_DIMENSIONS: ${EMBEDDING_DIMENSIONS:-384}

      # Service Discovery
      PRODUCT_SERVICE_URL: http://product-service:8083
      CART_SERVICE_URL: http://cart-service:8082

      # Circuit Breaker
      CIRCUIT_BREAKER_MAX_REQUESTS: ${CIRCUIT_BREAKER_MAX_REQUESTS:-3}
      CIRCUIT_BREAKER_TIMEOUT: ${CIRCUIT_BREAKER_TIMEOUT:-60s}

    healthcheck:
      <<: *common-healthcheck
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8081/internal/health"]
    depends_on:
      - product-service
      - cart-service

  # ---------------------------------------------------------------------------
  # Cart Service
  # ---------------------------------------------------------------------------
  cart-service:
    <<: *common-service
    build:
      context: ./cart-service
      dockerfile: Dockerfile
      args:
        <<: *golang-build-args
    container_name: chatbot-cart-service
    ports:
      - "${CART_SERVICE_PORT:-8082}:8082"
    environment:
      <<: *surrealdb-env
      SERVICE_NAME: cart-service
      PORT: 8082
      LOG_LEVEL: ${LOG_LEVEL:-info}

      # SurrealDB Auth
      SURREALDB_USER: cart_service
      SURREALDB_PASSWORD: ${CART_SERVICE_DB_PASSWORD}

      # Service Discovery
      PRODUCT_SERVICE_URL: http://product-service:8083
      SESSION_SERVICE_URL: http://session-service:8084

      # Cart Configuration
      MAX_CART_ITEMS: ${MAX_CART_ITEMS:-50}
      MAX_ITEM_QUANTITY: ${MAX_ITEM_QUANTITY:-100}

    healthcheck:
      <<: *common-healthcheck
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8082/internal/health"]
    depends_on:
      - product-service

  # ---------------------------------------------------------------------------
  # Product Service
  # ---------------------------------------------------------------------------
  product-service:
    <<: *common-service
    build:
      context: ./product-service
      dockerfile: Dockerfile
      args:
        <<: *golang-build-args
    container_name: chatbot-product-service
    ports:
      - "${PRODUCT_SERVICE_PORT:-8083}:8083"
    environment:
      <<: *surrealdb-env
      SERVICE_NAME: product-service
      PORT: 8083
      LOG_LEVEL: ${LOG_LEVEL:-info}

      # SurrealDB Auth
      SURREALDB_USER: product_service
      SURREALDB_PASSWORD: ${PRODUCT_SERVICE_DB_PASSWORD}

      # Embedding Service
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-sentence-transformers/all-MiniLM-L6-v2}
      EMBEDDING_DIMENSIONS: ${EMBEDDING_DIMENSIONS:-384}

      # Vector Search
      VECTOR_SEARCH_THRESHOLD: ${VECTOR_SEARCH_THRESHOLD:-0.7}
      VECTOR_SEARCH_LIMIT: ${VECTOR_SEARCH_LIMIT:-5}

      # Caching
      ENABLE_CACHE: ${ENABLE_CACHE:-true}
      CACHE_TTL: ${CACHE_TTL:-300}

    healthcheck:
      <<: *common-healthcheck
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8083/internal/health"]

  # ---------------------------------------------------------------------------
  # Session Service
  # ---------------------------------------------------------------------------
  session-service:
    <<: *common-service
    build:
      context: ./session-service
      dockerfile: Dockerfile
      args:
        <<: *golang-build-args
    container_name: chatbot-session-service
    ports:
      - "${SESSION_SERVICE_PORT:-8084}:8084"
    environment:
      <<: *surrealdb-env
      SERVICE_NAME: session-service
      PORT: 8084
      LOG_LEVEL: ${LOG_LEVEL:-info}

      # SurrealDB Auth
      SURREALDB_USER: session_service
      SURREALDB_PASSWORD: ${SESSION_SERVICE_DB_PASSWORD}

      # Service Discovery
      CART_SERVICE_URL: http://cart-service:8082
      PRODUCT_SERVICE_URL: http://product-service:8083

      # Session Configuration
      SESSION_TIMEOUT: ${SESSION_TIMEOUT:-24h}
      SESSION_CLEANUP_INTERVAL: ${SESSION_CLEANUP_INTERVAL:-1h}

    healthcheck:
      <<: *common-healthcheck
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8084/internal/health"]
    depends_on:
      - cart-service
      - product-service

  # ---------------------------------------------------------------------------
  # Recommendation Service
  # ---------------------------------------------------------------------------
  recommendation-service:
    <<: *common-service
    build:
      context: ./recommendation-service
      dockerfile: Dockerfile
      args:
        <<: *golang-build-args
    container_name: chatbot-recommendation-service
    ports:
      - "${RECOMMEND_SERVICE_PORT:-8085}:8085"
    environment:
      SERVICE_NAME: recommendation-service
      PORT: 8085
      LOG_LEVEL: ${LOG_LEVEL:-info}

      # Service Discovery
      CART_SERVICE_URL: http://cart-service:8082
      PRODUCT_SERVICE_URL: http://product-service:8083

      # Recommendation Configuration
      MAX_RECOMMENDATIONS: ${MAX_RECOMMENDATIONS:-5}
      MIN_SCORE: ${MIN_SCORE:-3.0}

      # Caching
      ENABLE_CACHE: ${ENABLE_CACHE:-true}
      CACHE_TTL: ${CACHE_TTL:-600}

    healthcheck:
      <<: *common-healthcheck
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8085/internal/health"]
    depends_on:
      - cart-service
      - product-service

# =============================================================================
# Networks
# =============================================================================
networks:
  chatbot-network:
    driver: bridge
    name: chatbot-network

# =============================================================================
# Volumes (Optional - for future use)
# =============================================================================
volumes:
  # Placeholder for future volume needs (e.g., local cache, logs)
  cache-data:
    driver: local
